function checkTrainingStatus(){fetch("http://0.0.0.0:7890/trainingstatus").then(e=>e.json()).then(e=>{0==e.status?(document.querySelector("#qiniu_tm_class_training").textContent="开始训练",document.querySelector("#qiniu_tm_class_training").removeAttribute("disabled")):(document.querySelector("#qiniu_tm_class_training").textContent="模型训练中... ...",document.querySelector("#qiniu_tm_class_training").setAttribute("disabled","disabled"))})}function reloadLabelTool(){labeltool&&labeltool.destory(),document.querySelector("#qiniu_tm_contentfiller").innerHTML="",DATA=new NiuArray;let e=document.querySelector("#qiniu_tm_imgmarker"),t=document.querySelector("#qiniu_tm_img");labeltool=new labelTool(e,t,DATA)}function refreshList(e,t){let n="";t.forEach(function(e){n+=`<div class="card bg-light ${e.isKey?"text-primary border-primary":"text-success border-success"} mb-3">
                    <div class="card-header">
                        ${(e.isKey?"Key: ":"Value: ")+e.id}
                        <button type="button" class="close" aria-label="Close">
                            <span aria-hidden="true" class="js-qiniu-tm-tab-remove" data-id="${e.id||""}">&times;</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">名称</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control js-qiniu-tm-focus" placeholder="standard name" data-item="standard_name" data-id="${e.id||""}" value="${e.standard_name||""}" ／>
                            </div>
                            <label class="col-sm-2 col-form-label">类型</label>
                            <div class="col-sm-4">
                                <select class="custom-select js-qiniu-tm-focus"  data-id="${e.id||""}"  data-item="classtype" value="${e.classtype||""}">
                                    <option value="key" ${"key"==e.classtype?"selected":""}>关键词</option>
                                    <option value="title" ${"title"==e.classtype?"selected":""}>主标题</option>
                                    <option value="subtitle" ${"subtitle"==e.classtype?"selected":""}>副标题</option>
                                    <option value="contenttype" ${"contenttype"==e.classtype?"selected":""}>内容类型</option>
                                </select>    
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">内容*</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control js-qiniu-tm-focus" placeholder="content" data-item="content" data-id="${e.id||""}" value="${e.content||""}" ／>
                            </div>
                            <label class="col-sm-2 col-form-label">权重</label>
                            <div class="col-sm-4">
                                <input type="number" class="form-control js-qiniu-tm-focus" name="quantity" min="1" max="5" data-item="weight" data-id="${e.id||""}" value="${e.weight||1}" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">同义词</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control js-qiniu-tm-focus" placeholder="prob_names" data-item="prob_names" data-id="${e.id||""}" value="${e.prob_names||""}" ／>
                            </div>
                        </div>
                    </div>
                </div>`}),e.innerHTML=n,document.querySelectorAll(".js-qiniu-tm-focus").forEach(e=>e.addEventListener("focus",function(e){let t=DATA.findIndex(t=>t.id==e.target.dataset.id),n=DATA[t].node.getAttribute("class")+" qiniu-tm-selecthover-on";DATA[t].node.setAttribute("class",n)})),document.querySelectorAll(".js-qiniu-tm-focus").forEach(e=>e.addEventListener("blur",function(e){let t=DATA.findIndex(t=>t.id==e.target.dataset.id),n=DATA[t].node.getAttribute("class").replace(" qiniu-tm-selecthover-on","");DATA[t].node.setAttribute("class",n)})),document.querySelectorAll(".js-qiniu-tm-focus").forEach(e=>e.addEventListener("change",function(e){DATA[DATA.findIndex(t=>t.id==e.target.dataset.id)][e.target.dataset.item]=e.target.value})),document.querySelectorAll(".js-qiniu-tm-tab-remove").forEach(e=>e.addEventListener("click",function(e){let t=DATA.findIndex(t=>t.id==e.target.dataset.id);DATA[t].node.remove(),DATA.splice(t,1)}))}function refreshImgList(){let e={headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({fileName:document.querySelector("#qiniu_tm_chooseclass").value})};fetch("getImglist",e).then(e=>e.json()).then(e=>{let t="";LIST=e.label,e.imgList.length&&(t=e.imgList.map(t=>{let n=e.label.map(e=>e.fileName);return`<li class="list-group-item qiniu-tm-listitem-choose ${n.indexOf(t)>-1?"list-group-item-success":""}" data-filename="${t||""}">
                            ${t} ${n.indexOf(t)>-1?"（已标注）":""}
                            <button type="button" class="close" aria-label="Close">
                                <span aria-hidden="true" class="js-qiniu-tm-listitem-remove" data-filename="${t||""}">&times;</span>
                            </button>
                        </li>`}),t=t.join("")),document.querySelector("#qiniu_tm_listcontainer_list ul").innerHTML=t,document.querySelectorAll(".js-qiniu-tm-listitem-remove").forEach(e=>e.addEventListener("click",function(e){if(e.stopPropagation(),e.preventDefault(),1==confirm("您确定要删除这个模版吗？")){let t={headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({className:document.querySelector("#qiniu_tm_chooseclass").value,fileName:e.target.dataset.filename})};fetch("/removeimg",t).then(function(e){console.log("response: ",e),refreshImgList()})}})),document.querySelectorAll(".qiniu-tm-listitem-choose").forEach(e=>e.addEventListener("click",function(e){let t=e.target.dataset.filename,n=LIST.filter(e=>e.fileName==t);0!==n.length&&n[0].data.forEach(e=>DATA.push(e));let i="/file/imgs/"+document.querySelector("#qiniu_tm_chooseclass").value+"/"+t;document.querySelector("#qiniu_tm_img").src=i,labeltool.init(i).then(e=>{let t=document.querySelector("#qiniu_tm_imgmarker"),n=document.querySelector("#qiniu_tm_img");t.style.height=n.clientHeight,labeltool.inputBBox(DATA)}),document.querySelector("#qiniu_tm_listcontainer").hidden=!0,document.querySelector("#qiniu_tm_imgcontainer").hidden=!1,document.querySelector("#qiniu_tm_detailpanel_btngroup_cancel").removeAttribute("disabled"),document.querySelector("#qiniu_tm_detailpanel_btngroup_submit").removeAttribute("disabled"),document.querySelector("#qiniu_tm_imgcontainer_title_classname").innerHTML=document.querySelector("#qiniu_tm_chooseclass").value,document.querySelector("#qiniu_tm_imgcontainer_title_filename").innerHTML=t}))})}function setKeyFun(e){e.stopPropagation(),e.preventDefault();let t=DATA.findIndex(t=>t.id==e.target.dataset.id);DATA[t].isKey=!0,DATA[t].node.setAttribute("stroke","#1E90FF"),DATA[t].node.setAttribute("fill","#1E90FF"),refreshList(document.querySelector("#qiniu_tm_contentfiller"),DATA)}function setValueFun(e){e.stopPropagation(),e.preventDefault();let t=DATA.findIndex(t=>t.id==e.target.dataset.id);DATA[t].isKey=!1,DATA[t].node.setAttribute("stroke","#28a745"),DATA[t].node.setAttribute("fill","#28a745"),refreshList(document.querySelector("#qiniu_tm_contentfiller"),DATA)}function refreshSelector(){fetch("/getfilelist").then(e=>e.json()).then(function(e){let t=e.map(e=>{return e=e.replace(".json",""),`<option value="${e}">${e}</option>`});document.querySelector("#qiniu_tm_chooseclass").innerHTML=t.join(""),localStorage.getItem("chosenclass")&&(document.querySelector("#qiniu_tm_chooseclass").value=localStorage.getItem("chosenclass")),refreshImgList()})}function getBase64Image(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height),t.toDataURL("image/png").replace("data:image/png;base64,","")}class NiuArray extends Array{constructor(...e){super(...e),this.Container=document.querySelector("#qiniu_tm_contentfiller")}push(...e){return super.push(...e),refreshList(this.Container,DATA),this}splice(...e){return super.splice(...e),refreshList(this.Container,DATA),this}}let labeltool=null,DATA=null,LIST=null,isNew=!0;window.onload=function(){reloadLabelTool(),refreshSelector(),document.querySelector("#qiniu_tm_imgcontainer").hidden=!0,document.querySelector("#qiniu_tm_imgselector").addEventListener("change",function(e){if(e.target.files.length){let t=[];for(let n=0;n<e.target.files.length;n++){t.push(e.target.files[n].name);let i=window.URL.createObjectURL(e.target.files[n]),o=new Image;o.src=i;getBase64Image(o)}document.querySelector("#qiniu_tm_uploadimg_label").textContent=t.join("; ")}})},document.querySelectorAll("#qiniu_tm_detailpanel_toolbox label")[0].addEventListener("click",function(e){document.querySelectorAll("polygon").forEach(e=>e.removeEventListener("click",setKeyFun)),document.querySelectorAll("polygon").forEach(e=>e.removeEventListener("click",setValueFun))}),document.querySelectorAll("#qiniu_tm_detailpanel_toolbox label")[1].addEventListener("click",function(e){document.querySelectorAll("polygon").forEach(e=>e.addEventListener("click",setKeyFun)),document.querySelectorAll("polygon").forEach(e=>e.removeEventListener("click",setValueFun))}),document.querySelectorAll("#qiniu_tm_detailpanel_toolbox label")[2].addEventListener("click",function(e){document.querySelectorAll("polygon").forEach(e=>e.addEventListener("click",setValueFun)),document.querySelectorAll("polygon").forEach(e=>e.removeEventListener("click",setKeyFun))}),document.querySelector("#qiniu_tm_createnewclass").addEventListener("click",function(e){$("#qiniu_tm_createnewclass_modal").modal("toggle")}),document.querySelector("#qiniu_tm_class_delete").addEventListener("click",function(e){if(1==confirm("您确定要删除这个分类及其所有样本数据吗？")){let e={headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({fileName:document.querySelector("#qiniu_tm_chooseclass").value})};fetch("deleteclass",e).then(e=>{console.log(e),localStorage.removeItem("chosenclass"),refreshSelector()})}}),document.querySelector("#qiniu_tm_createnewclass_submit").addEventListener("click",function(e){let t={headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({fileName:document.querySelector("#qiniu_tm_templatename").value})};fetch("createnewclass",t).then(e=>{console.log(e),refreshSelector(),$("#qiniu_tm_createnewclass_modal").modal("toggle")})}),document.querySelector("#qiniu_tm_chooseclass").addEventListener("change",function(e){localStorage.setItem("chosenclass",e.target.value),refreshImgList()}),document.querySelector("#qiniu_tm_class_training").addEventListener("click",function(e){1==confirm("训练过程将耗时30分钟，确定要开启新的训练？")&&fetch("/saveouttrainingconf").then(e=>{fetch("http://0.0.0.0:7890/starttraining").then(e=>{document.querySelector("#qiniu_tm_class_training").textContent="模型训练中... ...",document.querySelector("#qiniu_tm_class_training").setAttribute("disabled","disabled")})})}),document.querySelector("#qiniu_tm_detailpanel_btngroup_cancel").addEventListener("click",function(e){reloadLabelTool(),refreshImgList(),document.querySelector("#qiniu_tm_listcontainer").hidden=!1,document.querySelector("#qiniu_tm_imgcontainer").hidden=!0,document.querySelector("#qiniu_tm_detailpanel_btngroup_cancel").setAttribute("disabled","disabled"),document.querySelector("#qiniu_tm_detailpanel_btngroup_submit").setAttribute("disabled","disabled")}),document.querySelector("#qiniu_tm_detailpanel_btngroup_submit").addEventListener("click",function(e){let t=document.querySelector("#qiniu_tm_chooseclass").value,n={fileName:document.querySelector("#qiniu_tm_imgcontainer_title_filename").textContent,data:DATA},i=LIST.filter(e=>e.fileName==n.fileName);0==i.length?LIST.push(n):i[0].data=DATA;let o={headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({fileName:t,data:LIST})};fetch("/submit",o).then(function(e){console.log("response: ",e)})});