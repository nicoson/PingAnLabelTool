class labelTool{constructor(t,e,s){this.img=null,this.svgContainer=t,this.imgContainer=e,this.datalist=s,this.count=s.slice(-1).length?s.slice(-1)[0].id+1:0,this.stretchRate=1,this.startX=null,this.startY=null,this.endX=null,this.endY=null,this.centerX=null,this.centerY=null,this.radius=null,this.step=1,this.createLabelMarkers(),this.createEvents()}init(t){return this.img=new Image,this.img.src=t,new Promise((t,e)=>{this.img.onload=function(){this.stretchRate=this.img.width/this.imgContainer.offsetWidth,console.log(this.stretchRate),t()}.bind(this)})}destory(){this.svgContainer.parentElement.removeChild(this.svgContainer);let t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("id","qiniu_tm_imgmarker"),this.imgContainer.src="",this.imgContainer.parentElement.appendChild(t)}startTrace(){createEvents()}stopTrace(){}createLabelMarkers(){this.currentNode=document.createElementNS("http://www.w3.org/2000/svg","polygon"),this.currentNode.setAttribute("stroke","#28a745"),this.currentNode.setAttribute("stroke-width",1),this.currentNode.setAttribute("stroke-opacity",1),this.currentNode.setAttribute("fill","#28a745"),this.currentNode.setAttribute("fill-opacity",.2),this.currentNode.setAttribute("class","qiniu-tm-selecthover"),this.svgContainer.appendChild(this.currentNode),this.cycleEle=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.cycleEle.setAttribute("stroke","grey"),this.cycleEle.setAttribute("stroke-width",1),this.cycleEle.setAttribute("stroke-opacity",.8),this.cycleEle.setAttribute("fill","grey"),this.cycleEle.setAttribute("fill-opacity",.2),this.svgContainer.appendChild(this.cycleEle),this.textNode=document.createElementNS("http://www.w3.org/2000/svg","text"),this.textNode.setAttribute("id","tmp_text"),this.textNode.setAttribute("x","0"),this.textNode.setAttribute("y","0"),this.textNode.setAttribute("stroke","blue"),this.textNode.setAttribute("stroke-width",1),this.textNode.innerHTML=null,this.svgContainer.appendChild(this.textNode)}createEvents(){this.clickEvent=this.svgContainer.addEventListener("click",this.clickEventFun.bind(this)),this.mouseMoveEvent=this.svgContainer.addEventListener("mousemove",function(t){if(2===this.step){this.endX=t.offsetX,this.endY=t.offsetY,this.radius=Math.sqrt((this.startX-this.endX)**2+(this.startY-this.endY)**2)/2,this.centerX=(this.startX+this.endX)/2,this.centerY=(this.startY+this.endY)/2,this.cycleEle.setAttribute("cx",this.centerX),this.cycleEle.setAttribute("cy",this.centerY),this.cycleEle.setAttribute("r",this.radius);let e=`${this.startX},${this.startY} ${this.endX},${this.startY} ${this.endX},${this.endY} ${this.startX},${this.endY}`;this.currentNode.setAttribute("points",e)}else if(3===this.step){let e=t.offsetX,s=t.offsetY,i=Math.sqrt((e-this.centerX)**2+(s-this.centerY)**2),h=this.centerX+this.radius/i*(e-this.centerX),n=this.centerY+this.radius/i*(s-this.centerY),r=this.endX-(h-this.startX),o=this.endY-(n-this.startY),c=`${this.startX},${this.startY} ${h},${n} ${this.endX},${this.endY} ${r},${o}`;this.currentNode.setAttribute("points",c)}this.textNode.setAttribute("x",t.offsetX+10),this.textNode.setAttribute("y",t.offsetY-10),this.textNode.innerHTML=`(${t.offsetX}, ${t.offsetY})`}.bind(this))}clickEventFun(t){switch(this.step){case 1:this.startX=t.offsetX,this.startY=t.offsetY,this.step=2;break;case 2:this.step=3;break;case 3:this.step=1,this.cycleEle.setAttribute("r",0),this.currentNode.setAttribute("data-id",this.count);let e={id:this.count,classtype:"key",node:this.currentNode.cloneNode(!0),bbox:this.currentNode.getAttribute("points").split(" ").map(t=>t.split(",")).map(t=>t.map(t=>t*this.stretchRate)),isKey:!1};this.datalist.push(e),this.svgContainer.appendChild(e.node),this.currentNode.setAttribute("points",""),this.count++}}inputBBox(t){this.datalist=t,this.count=t.slice(-1).length?t.slice(-1)[0].id+1:0,this.datalist.forEach(function(t){let e=`${t.bbox[0][0]/this.stretchRate},${t.bbox[0][1]/this.stretchRate} 
                            ${t.bbox[1][0]/this.stretchRate},${t.bbox[1][1]/this.stretchRate} 
                            ${t.bbox[2][0]/this.stretchRate},${t.bbox[2][1]/this.stretchRate} 
                            ${t.bbox[3][0]/this.stretchRate},${t.bbox[3][1]/this.stretchRate}`,s=document.createElementNS("http://www.w3.org/2000/svg","polygon");s.setAttribute("stroke",t.isKey?"#1E90FF":"#28a745"),s.setAttribute("stroke-width",1),s.setAttribute("stroke-opacity",1),s.setAttribute("fill",t.isKey?"#1E90FF":"#28a745"),s.setAttribute("fill-opacity",.2),s.setAttribute("class","qiniu-tm-selecthover"),s.setAttribute("data-id",t.id),s.setAttribute("points",e),this.svgContainer.appendChild(s),t.node=s}.bind(this))}}